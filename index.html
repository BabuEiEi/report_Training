<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ระบบรายงานการอบรมครู โรงเรียนครูเปิงมางfc</title>
    
    <!-- Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prop-types/15.8.1/prop-types.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react-is/18.2.0/umd/react-is.production.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.0/Recharts.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;600;700&display=swap');
        
        body { 
            font-family: 'Sarabun', sans-serif; 
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            min-height: 100vh;
        }
        
        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #64748b; }
        
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* --- Print Styles (A4 Optimized) --- */
        @media print {
            @page {
                size: A4;
                margin: 1.5cm; /* ระยะขอบมาตรฐาน A4 */
            }

            /* Hide unwanted elements */
            nav, footer, .no-print, button, .swal2-container { 
                display: none !important; 
            }

            /* Reset Body & Backgrounds */
            body { 
                background: white !important; 
                font-size: 14px; /* ขนาดตัวอักษรมาตรฐานเอกสาร */
                color: black !important;
                margin: 0;
                padding: 0;
            }
            .bg-gray-50, .bg-gray-100, .bg-blue-50, .bg-white { 
                background-color: white !important; 
            }
            
            /* Remove Shadows & Borders Effects */
            .shadow, .shadow-md, .shadow-lg, .shadow-xl { 
                box-shadow: none !important; 
            }
            .rounded-lg, .rounded-xl, .rounded-2xl {
                border-radius: 0 !important;
            }

            /* Modal Handling: Make it fill the page */
            #report-modal-wrapper, #detail-modal-wrapper, #admin-report-modal-wrapper {
                position: absolute !important;
                top: 0 !important;
                left: 0 !important;
                width: 100% !important;
                height: auto !important;
                z-index: 9999;
                background: white !important;
                padding: 0 !important;
                margin: 0 !important;
                overflow: visible !important;
                display: block !important;
            }
            
            #report-modal-content, #detail-modal-content, #admin-report-modal-content {
                width: 100% !important;
                max-width: 100% !important;
                max-height: none !important; /* ปลดล็อกความสูงตอนพิมพ์ */
                margin: 0 !important;
                padding: 0 !important;
                border: none !important;
                box-shadow: none !important;
                position: static !important;
                overflow: visible !important; /* ปลดล็อก scrollbar ตอนพิมพ์ */
            }
            
            /* Hide internal scrollbar containers during print */
            #detail-modal-body {
                overflow: visible !important;
                padding: 0 !important;
            }

            /* Hide Main Content if Modal is Open */
            /* Note: React renders modal inside App, so we rely on modal covering everything with white bg */
            
            /* Typography for Print */
            h1 { font-size: 24px !important; font-weight: bold !important; margin-bottom: 15px; color: black !important; }
            h2 { font-size: 20px !important; font-weight: bold !important; margin-bottom: 10px; color: black !important; }
            h3 { font-size: 18px !important; font-weight: bold !important; color: black !important; }
            p, span, div { color: black !important; }
            
            /* Table Styling for Print */
            table { 
                width: 100% !important; 
                border-collapse: collapse !important; 
                font-size: 14px !important;
                margin-top: 20px;
                margin-bottom: 20px;
            }
            th, td { 
                border: 1px solid black !important; 
                padding: 8px !important; 
                color: black !important; 
                page-break-inside: avoid;
            }
            thead { 
                display: table-header-group; 
                background-color: #f3f4f6 !important; 
                font-weight: bold;
            }
            thead th {
                background-color: #e5e7eb !important; /* สีหัวตารางเทาอ่อน */
                -webkit-print-color-adjust: exact; 
                print-color-adjust: exact;
            }
            tr { page-break-inside: avoid; page-break-after: auto; }

            /* Grid Layouts to Block for Print safety */
            .grid { display: block !important; }
            .grid > div { margin-bottom: 10px; }
            .col-span-2 { width: 100% !important; }

            /* Signature Section */
            .signature-section {
                display: flex !important;
                justify-content: space-between !important;
                margin-top: 50px !important;
                page-break-inside: avoid;
            }
            .signature-box {
                text-align: center;
                width: 45%;
            }
            
            /* Images */
            img { max-width: 100% !important; height: auto !important; page-break-inside: avoid; }
            
            /* List View Specifics */
            .print-hidden { display: none !important; }
            .print-visible { display: block !important; }
            .overflow-x-auto { overflow: visible !important; }
        }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const RechartsObj = window.Recharts || {};
        const { LineChart, Line, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, BarChart, Bar, PieChart, Pie, Cell, Legend } = RechartsObj;
        const isRechartsLoaded = !!window.Recharts;

        // Chart Colors
        const COLORS = ['#3B82F6', '#10B981', '#F59E0B', '#EF4444', '#8B5CF6', '#EC4899'];

        // --- Icon Component ---
        const Icon = ({ name, className }) => {
            const icons = {
                FileText: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/><polyline points="14 2 14 8 20 8"/></svg>,
                Plus: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>,
                User: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>,
                LogOut: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
                CheckCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/></svg>,
                XCircle: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"/><line x1="15" y1="9" x2="9" y2="15"/><line x1="9" y1="9" x2="15" y2="15"/></svg>,
                Search: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg>,
                Trash2: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/><line x1="10" y1="11" x2="10" y2="17"/><line x1="14" y1="11" x2="14" y2="17"/></svg>,
                Edit: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/></svg>,
                Save: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z"/><polyline points="17 21 17 13 7 13 7 21"/><polyline points="7 3 7 8 15 8"/></svg>,
                Download: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
                Calendar: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>,
                Eye: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>,
                Lock: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/></svg>,
                Image: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><circle cx="8.5" cy="8.5" r="1.5"/><polyline points="21 15 16 10 5 21"/></svg>,
                Printer: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="6 9 6 2 18 2 18 9"/><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"/><rect x="6" y="14" width="12" height="8"/></svg>,
                Upload: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg>,
                Trophy: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M8 21h8m-4-9v9m-8-3h16m-7-6V6a5 5 0 0 1 10 0v3a5 5 0 0 1-10 0z"/></svg>,
                PieChart: <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.21 15.89A10 10 0 1 1 8 2.83"/><path d="M22 12A10 10 0 0 0 12 2v10z"/></svg>
            };
            return icons[name] || null;
        };

        const GOOGLE_DRIVE_FOLDER_ID = '1hWef8deZAgcgPkptOgtJvuPglYsWyG94';
        const ACTIVITY_TYPES = ['อบรม', 'ประชุม', 'ศึกษาดูงาน', 'นวัตกรรม', 'PLC', 'อื่นๆ'];
        const getFiscalYear = (dateStr) => {
            if (!dateStr) return new Date().getFullYear() + 543;
            const date = new Date(dateStr);
            return (date.getMonth() + 1) >= 10 ? date.getFullYear() + 543 + 1 : date.getFullYear() + 543;
        };

        function App() {
            const [user, setUser] = useState(null);
            const [view, setView] = useState('dashboard');
            const [trainings, setTrainings] = useState([]);
            const [formData, setFormData] = useState({ images: [] });
            const [searchTerm, setSearchTerm] = useState('');
            const [selectedYear, setSelectedYear] = useState('All');
            const [loginPass, setLoginPass] = useState('');
            const [detailItem, setDetailItem] = useState(null);
            const [reportPerson, setReportPerson] = useState(null);
            const [showAdminReport, setShowAdminReport] = useState(false);
            const [isLoading, setIsLoading] = useState(true);
            const [loadingMessage, setLoadingMessage] = useState('');
            const [localFiles, setLocalFiles] = useState([null, null, null, null]);
            
            const [quickSearch, setQuickSearch] = useState('');
            const [page, setPage] = useState(1);
            const itemsPerPage = 5;

            useEffect(() => {
                setIsLoading(true);
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler((data) => { setTrainings(data); setIsLoading(false); })
                        .withFailureHandler((err) => { 
                            Swal.fire({ icon: 'error', title: 'Error', text: err });
                            setIsLoading(false); 
                        })
                        .getTrainings();
                } else {
                    const localData = localStorage.getItem('training_data');
                    setTrainings(localData ? JSON.parse(localData) : []);
                    setIsLoading(false);
                }
            }, []);

            const handleLogin = (e) => {
                e.preventDefault();
                if (loginPass === '1234') { setUser('admin'); setView('dashboard'); setLoginPass(''); } 
                else { Swal.fire({ icon: 'error', title: 'รหัสผ่านไม่ถูกต้อง', timer: 1500, showConfirmButton: false }); }
            };

            const handleLogout = () => {
                Swal.fire({
                    icon: 'success',
                    title: 'ออกจากระบบเรียบร้อย',
                    timer: 1500,
                    showConfirmButton: false
                }).then(() => {
                    setUser(null);
                    setView('dashboard');
                });
            };

            const uploadFileToDrive = (file) => {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        const content = e.target.result.split(',')[1];
                        google.script.run
                            .withSuccessHandler((id) => resolve(id))
                            .withFailureHandler((err) => reject(err))
                            .uploadImageToDrive(content, file.name, file.type);
                    };
                    reader.readAsDataURL(file);
                });
            };

            const handleFormSubmit = async (e) => {
                e.preventDefault();
                
                Swal.fire({
                    title: 'กำลังบันทึกข้อมูล...',
                    text: 'กรุณารอสักครู่ ระบบกำลังอัปโหลดรูปภาพและบันทึก',
                    allowOutsideClick: false,
                    didOpen: () => { Swal.showLoading(); }
                });

                let finalImageIds = [...(formData.images || [])];

                if (typeof google !== 'undefined' && google.script) {
                    try {
                        const uploadPromises = localFiles.map(async (file, index) => {
                            if (file) {
                                const id = await uploadFileToDrive(file);
                                finalImageIds[index] = id;
                            }
                            return;
                        });
                        await Promise.all(uploadPromises);
                    } catch (error) {
                        Swal.fire({ icon: 'error', title: 'เกิดข้อผิดพลาด', text: "การอัปโหลดรูปภาพล้มเหลว: " + error });
                        return;
                    }
                }

                const fiscalYear = getFiscalYear(formData.dateStart);
                const newRecord = {
                    ...formData,
                    id: formData.id || '',
                    status: formData.status || 'pending',
                    hours: parseFloat(formData.hours),
                    year: fiscalYear,
                    images: finalImageIds,
                    reporter: formData.reporter || 'ไม่ระบุชื่อ',
                    bookNumber: formData.bookNumber || '-',
                    locationDetail: formData.locationDetail || '-',
                    benefits: formData.benefits || '-'
                };

                if (typeof google !== 'undefined' && google.script) {
                    google.script.run
                        .withSuccessHandler((res) => {
                            google.script.run.withSuccessHandler(data => {
                                setTrainings(data); 
                                setView('list'); 
                                setFormData({ images: [] });
                                setLocalFiles([null, null, null, null]);
                                Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ!', timer: 1500, showConfirmButton: false });
                            }).getTrainings();
                        })
                        .withFailureHandler(err => {
                            Swal.fire({ icon: 'error', title: 'บันทึกไม่สำเร็จ', text: err });
                        })
                        .saveTraining(newRecord);
                } else {
                    const updated = formData.id 
                        ? trainings.map(t => t.id === formData.id ? { ...newRecord, id: formData.id } : t)
                        : [...trainings, { ...newRecord, id: Date.now().toString() }];
                    setTrainings(updated);
                    localStorage.setItem('training_data', JSON.stringify(updated));
                    setView('list'); 
                    setFormData({ images: [] });
                    setLocalFiles([null, null, null, null]);
                    Swal.fire({ icon: 'success', title: 'บันทึกสำเร็จ!', timer: 1500, showConfirmButton: false });
                }
            };

            const handleDelete = (id) => {
                Swal.fire({
                    title: 'ยืนยันการลบ?',
                    text: "คุณต้องการลบข้อมูลนี้ใช่หรือไม่ การกระทำนี้ไม่สามารถย้อนกลับได้",
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonColor: '#d33',
                    cancelButtonColor: '#3085d6',
                    confirmButtonText: 'ลบข้อมูล',
                    cancelButtonText: 'ยกเลิก'
                }).then((result) => {
                    if (result.isConfirmed) {
                        Swal.fire({ title: 'กำลังลบ...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                        
                        if (typeof google !== 'undefined' && google.script) {
                            google.script.run.withSuccessHandler(() => {
                                 setTrainings(prev => prev.filter(t => t.id != id)); 
                                 Swal.fire({ icon: 'success', title: 'ลบสำเร็จ', timer: 1500, showConfirmButton: false });
                            }).deleteTraining(id);
                        } else {
                            const updated = trainings.filter(t => t.id !== id);
                            setTrainings(updated);
                            localStorage.setItem('training_data', JSON.stringify(updated));
                            Swal.fire({ icon: 'success', title: 'ลบสำเร็จ', timer: 1500, showConfirmButton: false });
                        }
                    }
                });
            };

            const handleStatusChange = (id, newStatus) => {
                const item = trainings.find(t => t.id === id);
                if(!item) return;
                const updatedItem = { ...item, status: newStatus };
                setTrainings(prev => prev.map(t => t.id === id ? updatedItem : t));
                if (typeof google !== 'undefined' && google.script) {
                    google.script.run.saveTraining(updatedItem);
                }
            };

            const handleLocalFileChange = (index, file) => {
                const newFiles = [...localFiles];
                newFiles[index] = file;
                setLocalFiles(newFiles);
            };

            const stats = useMemo(() => {
                const filtered = selectedYear === 'All' ? trainings : trainings.filter(t => t.year.toString() === selectedYear.toString());
                const totalHours = filtered.reduce((sum, t) => sum + (parseFloat(t.hours) || 0), 0);
                
                const reporterMap = {};
                filtered.forEach(t => {
                    const name = t.reporter || 'ไม่ระบุชื่อ';
                    reporterMap[name] = (reporterMap[name] || 0) + (parseFloat(t.hours) || 0);
                });
                const topReporters = Object.entries(reporterMap)
                    .map(([name, hours]) => ({ name, hours }))
                    .sort((a, b) => b.hours - a.hours)
                    .slice(0, 5);

                const typeMap = {};
                filtered.forEach(t => {
                    const type = t.type || 'อื่นๆ';
                    typeMap[type] = (typeMap[type] || 0) + 1;
                });
                const typeData = Object.entries(typeMap).map(([name, value]) => ({ name, value }));

                return { 
                    totalHours, 
                    totalCount: filtered.length, 
                    approvedCount: filtered.filter(t => t.status === 'approved').length, 
                    pendingCount: filtered.filter(t => t.status === 'pending').length, 
                    topReporters,
                    typeData
                };
            }, [trainings, selectedYear]);

            const personStats = useMemo(() => {
                const groups = {};
                const filtered = selectedYear === 'All' ? trainings : trainings.filter(t => t.year.toString() === selectedYear.toString());
                filtered.forEach(t => {
                    const name = t.reporter || 'ไม่ระบุชื่อ';
                    if (!groups[name]) groups[name] = { name, count: 0, hours: 0 };
                    groups[name].count += 1;
                    groups[name].hours += (parseFloat(t.hours) || 0);
                });
                return Object.values(groups);
            }, [trainings, selectedYear]);

            const availableYears = [...new Set(trainings.map(t => t.year))].sort((a,b) => b-a);

            const dashboardList = useMemo(() => {
                return trainings.filter(t => 
                    t.title.toLowerCase().includes(quickSearch.toLowerCase()) || 
                    t.reporter.toLowerCase().includes(quickSearch.toLowerCase()) ||
                    t.organizer.toLowerCase().includes(quickSearch.toLowerCase())
                );
            }, [trainings, quickSearch]);

            const paginatedDashboardList = dashboardList.slice((page - 1) * itemsPerPage, page * itemsPerPage);
            const totalPages = Math.ceil(dashboardList.length / itemsPerPage);

            // --- Detail Modal ---
            const DetailModal = () => {
                if (!detailItem) return null;
                return (
                    <div id="detail-modal-wrapper" className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                        <div id="detail-modal-content" className="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] flex flex-col relative transform transition-all scale-100">
                            <div className="flex justify-between items-center p-6 border-b border-gray-100 no-print flex-shrink-0">
                                <h3 className="text-2xl font-bold text-gray-800 flex items-center gap-2">
                                    <Icon name="FileText" className="w-6 h-6 text-blue-600"/>
                                    รายละเอียด
                                </h3>
                                <div className="flex space-x-3">
                                    <button onClick={() => window.print()} className="bg-gray-100 hover:bg-gray-200 text-gray-700 px-4 py-2 rounded-lg flex items-center text-sm font-medium transition-colors">
                                        <Icon name="Printer" className="w-4 h-4 mr-2" /> พิมพ์
                                    </button>
                                    <button onClick={() => setDetailItem(null)} className="text-gray-400 hover:text-red-500 transition-colors p-1">
                                        <Icon name="XCircle" className="w-8 h-8" />
                                    </button>
                                </div>
                            </div>
                            
                            <div id="detail-modal-body" className="p-8 overflow-y-auto">
                                <div className="hidden print:block text-center mb-8">
                                    <h1 className="text-2xl font-bold mb-2">โรงเรียนครูเปิงมางfc</h1>
                                    <h2 className="text-xl font-bold mb-2">รายงานบันทึกผลการพัฒนาตนเอง</h2>
                                    <p className="text-base text-gray-600">ประจำปีงบประมาณ {detailItem.year}</p>
                                    <p className="text-sm text-gray-500 mt-1">ผู้รายงาน: {detailItem.reporter || '-'}</p>
                                </div>

                                <div className="space-y-6 text-sm text-gray-700 print:text-black">
                                    <div className="bg-blue-50 p-4 rounded-xl border border-blue-100 print:bg-transparent print:border-none print:p-0">
                                        <h4 className="text-lg font-bold text-blue-800 mb-2 print:text-black">{detailItem.title}</h4>
                                        <div className="flex flex-wrap gap-2 no-print">
                                            <span className="bg-white px-2 py-1 rounded text-xs font-semibold text-blue-600 border border-blue-200">{detailItem.type}</span>
                                            <span className={`px-2 py-1 rounded text-xs font-semibold border ${detailItem.status==='approved'?'bg-green-50 text-green-700 border-green-200':'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>
                                                {detailItem.status==='approved'?'อนุมัติแล้ว':'รอตรวจสอบ'}
                                            </span>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-2 gap-6">
                                        <div><span className="font-semibold text-gray-500 block text-xs uppercase tracking-wider mb-1">เลขหนังสือ</span> {detailItem.bookNumber || '-'}</div>
                                        <div><span className="font-semibold text-gray-500 block text-xs uppercase tracking-wider mb-1">ผู้จัด</span> {detailItem.organizer}</div>
                                        <div><span className="font-semibold text-gray-500 block text-xs uppercase tracking-wider mb-1">วันเวลา</span> {detailItem.dateStart} - {detailItem.dateEnd}</div>
                                        <div><span className="font-semibold text-gray-500 block text-xs uppercase tracking-wider mb-1">จำนวนชั่วโมง</span> <span className="font-bold text-blue-600">{detailItem.hours} ชม.</span></div>
                                        <div className="col-span-2"><span className="font-semibold text-gray-500 block text-xs uppercase tracking-wider mb-1">สถานที่</span> {detailItem.location} ({detailItem.locationDetail || '-'})</div>
                                    </div>

                                    <div className="space-y-4">
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 print:bg-transparent print:border-gray-300 print:rounded-none">
                                            <span className="font-semibold text-gray-900 block mb-2">สิ่งที่ได้รับ / ความรู้ที่ได้:</span>
                                            <p className="whitespace-pre-line text-gray-600 leading-relaxed print:text-black">{detailItem.knowledge || '-'}</p>
                                        </div>
                                        <div className="bg-gray-50 p-4 rounded-xl border border-gray-100 print:bg-transparent print:border-gray-300 print:rounded-none">
                                            <span className="font-semibold text-gray-900 block mb-2">ประโยชน์ที่ได้รับ:</span>
                                            <p className="whitespace-pre-line text-gray-600 leading-relaxed print:text-black">{detailItem.benefits || '-'}</p>
                                        </div>
                                    </div>

                                    {detailItem.images && detailItem.images.some(i => i) && (
                                        <div className="mt-6 pt-6 border-t border-gray-100 print:border-gray-300">
                                            <span className="font-bold text-gray-900 block mb-4">ประมวลภาพกิจกรรม</span>
                                            <div className="grid grid-cols-2 gap-4">
                                                {detailItem.images.map((imgId, idx) => imgId ? (
                                                    <div key={idx} className="aspect-video rounded-lg overflow-hidden border border-gray-200 shadow-sm print:shadow-none print:border-gray-400">
                                                        <img src={`https://lh3.googleusercontent.com/d/${imgId}`} className="w-full h-full object-cover" onError={(e)=>{e.target.src='https://placehold.co/300x200?text=No+Image';}}/>
                                                    </div>
                                                ) : null)}
                                            </div>
                                        </div>
                                    )}
                                </div>

                                <div className="hidden print:flex signature-section">
                                    <div className="signature-box">
                                        <p className="mb-2">ลงชื่อ..........................................................</p>
                                        <p className="font-bold">({detailItem.reporter || '..........................................................'})</p>
                                        <p className="mt-1">ตำแหน่ง ครู</p>
                                    </div>
                                    <div className="signature-box">
                                        <p className="mb-2">ลงชื่อ..........................................................</p>
                                        <p className="font-bold">(..........................................................)</p>
                                        <p className="mt-1">ตำแหน่ง ผู้อำนวยการโรงเรียนครูเปิงมางfc</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Person Report Modal ---
            const ReportModal = () => {
                if (!reportPerson) return null;
                const personTrainings = trainings.filter(t => (t.reporter === reportPerson) && (selectedYear==='All' || t.year.toString()===selectedYear.toString()));
                const totalH = personStats.find(p => p.name === reportPerson)?.hours || 0;
                
                return (
                    <div id="report-modal-wrapper" className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                        <div id="report-modal-content" className="bg-white rounded-2xl shadow-2xl max-w-5xl w-full max-h-[90vh] flex flex-col relative my-8">
                            <div className="flex justify-between items-center p-6 border-b border-gray-100 no-print flex-shrink-0">
                                <h3 className="text-2xl font-bold text-gray-800">รายงานสรุปรายบุคคล</h3>
                                <div className="flex space-x-3">
                                    <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium shadow-md transition-all hover:shadow-lg">
                                        <Icon name="Printer" className="w-4 h-4 mr-2" /> พิมพ์รายงาน
                                    </button>
                                    <button onClick={() => setReportPerson(null)} className="text-gray-400 hover:text-red-500 transition-colors p-1">
                                        <Icon name="XCircle" className="w-8 h-8" />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-8 overflow-y-auto">
                                <div className="print:text-black">
                                    <div className="text-center mb-10">
                                        <h1 className="text-2xl font-bold mb-2">โรงเรียนครูเปิงมางfc</h1>
                                        <h2 className="text-xl font-bold mb-2 text-gray-900">สรุปรายการพัฒนาตนเอง</h2>
                                        <p className="text-lg text-gray-700 mb-1">ชื่อผู้รายงาน: <span className="font-bold text-blue-800 print:text-black">{reportPerson}</span></p>
                                        <p className="text-sm text-gray-500">ประจำปีงบประมาณ {selectedYear === 'All' ? 'ทั้งหมด' : selectedYear}</p>
                                    </div>
                                    
                                    <div className="overflow-hidden rounded-lg border border-gray-200 print:border-black">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-900 font-bold border-b border-gray-200 print:border-black print:bg-gray-200">
                                                <tr>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-12">ที่</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-28">ว/ด/ป</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black">หัวข้อการอบรม / กิจกรรม</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black">สถานที่</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-20">จำนวน ชม.</th>
                                                    <th className="p-3 text-center w-24">หมายเหตุ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200 print:divide-black">
                                                {personTrainings.map((item, index) => (
                                                    <tr key={index} className="hover:bg-gray-50 print:hover:bg-transparent">
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center">{index + 1}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center">{item.dateStart}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black font-medium">{item.title}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-gray-600 print:text-black">{item.organizer}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center font-bold">{item.hours}</td>
                                                        <td className="p-3 text-center text-xs">{item.type}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                            <tfoot className="bg-gray-50 font-bold border-t border-gray-200 print:border-black print:bg-gray-100">
                                                <tr>
                                                    <td colSpan="4" className="p-3 border-r border-gray-200 print:border-black text-right">รวมชั่วโมงการพัฒนาตนเอง</td>
                                                    <td className="p-3 border-r border-gray-200 print:border-black text-center text-blue-700 print:text-black text-lg">{totalH}</td>
                                                    <td className="p-3"></td>
                                                </tr>
                                            </tfoot>
                                        </table>
                                    </div>

                                    {/* Signature Section */}
                                    <div className="hidden print:flex signature-section">
                                        <div className="signature-box">
                                            <p className="mb-2">ลงชื่อ..........................................................</p>
                                            <p className="font-bold">({reportPerson})</p>
                                            <p className="mt-1">ตำแหน่ง ครู</p>
                                        </div>
                                        <div className="signature-box">
                                            <p className="mb-2">ลงชื่อ..........................................................</p>
                                            <p className="font-bold">(..........................................................)</p>
                                            <p className="mt-1">ตำแหน่ง ผู้อำนวยการโรงเรียนครูเปิงมางfc</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            // --- Admin Report Modal ---
            const AdminReportModal = () => {
                if (!showAdminReport) return null;
                const filteredTrainings = trainings.filter(t => selectedYear==='All' || t.year.toString()===selectedYear.toString());
                
                return (
                    <div id="admin-report-modal-wrapper" className="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center z-50 p-4 fade-in">
                        <div id="admin-report-modal-content" className="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] flex flex-col relative my-8">
                            <div className="flex justify-between items-center p-6 border-b border-gray-100 no-print flex-shrink-0">
                                <h3 className="text-2xl font-bold text-gray-800">รายงานสรุปภาพรวม (Admin)</h3>
                                <div className="flex space-x-3">
                                    <button onClick={() => window.print()} className="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center text-sm font-medium shadow-md transition-all hover:shadow-lg">
                                        <Icon name="Printer" className="w-4 h-4 mr-2" /> พิมพ์รายงาน
                                    </button>
                                    <button onClick={() => setShowAdminReport(false)} className="text-gray-400 hover:text-red-500 transition-colors p-1">
                                        <Icon name="XCircle" className="w-8 h-8" />
                                    </button>
                                </div>
                            </div>
                            
                            <div className="p-8 overflow-y-auto">
                                <div className="print:text-black">
                                    <div className="text-center mb-10">
                                        <h1 className="text-2xl font-bold mb-2">โรงเรียนครูเปิงมางfc</h1>
                                        <h2 className="text-xl font-bold mb-2 text-gray-900">รายงานสรุปการพัฒนาตนเองบุคลากร</h2>
                                        <p className="text-lg text-gray-600">ประจำปีงบประมาณ {selectedYear === 'All' ? 'ทั้งหมด' : selectedYear}</p>
                                    </div>
                                    
                                    <div className="overflow-hidden rounded-lg border border-gray-200 print:border-black">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-900 font-bold border-b border-gray-200 print:border-black print:bg-gray-200">
                                                <tr>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-10">ที่</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black w-40">ผู้รายงาน</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-24">ว/ด/ป</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black">หัวข้อการอบรม</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black w-32">หน่วยงานผู้จัด</th>
                                                    <th className="p-3 border-r border-gray-200 print:border-black text-center w-16">ชม.</th>
                                                    <th className="p-3 text-center w-24">หมายเหตุ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-200 print:divide-black">
                                                {filteredTrainings.map((item, index) => (
                                                    <tr key={index} className="hover:bg-gray-50 print:hover:bg-transparent">
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center">{index + 1}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black font-medium">{item.reporter}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center">{item.dateStart}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black">{item.title}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-gray-600 print:text-black text-xs">{item.organizer}</td>
                                                        <td className="p-3 border-r border-gray-200 print:border-black text-center font-bold">{item.hours}</td>
                                                        <td className="p-3 text-center text-xs">{item.type}</td>
                                                    </tr>
                                                ))}
                                            </tbody>
                                        </table>
                                    </div>

                                    {/* Signature Section */}
                                    <div className="hidden print:flex signature-section">
                                        <div className="signature-box">
                                            <p className="mb-2">ลงชื่อ..........................................................</p>
                                            <p className="font-bold">ผู้รายงานสรุป</p>
                                            <p className="mt-1">ตำแหน่ง ครู</p>
                                        </div>
                                        <div className="signature-box">
                                            <p className="mb-2">ลงชื่อ..........................................................</p>
                                            <p className="font-bold">(..........................................................)</p>
                                            <p className="mt-1">ตำแหน่ง ผู้อำนวยการโรงเรียนครูเปิงมางfc</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                );
            };

            const LoadingOverlay = () => isLoading && (
                <div className="fixed inset-0 bg-white/80 backdrop-blur-sm flex items-center justify-center z-[99] no-print fade-in">
                    <div className="flex flex-col items-center bg-white p-6 rounded-2xl shadow-xl border border-gray-100">
                        <div className="animate-spin rounded-full h-12 w-12 border-4 border-blue-100 border-t-blue-600 mb-4"></div>
                        <span className="text-gray-700 font-medium">{loadingMessage || 'กำลังโหลดข้อมูล...'}</span>
                    </div>
                </div>
            );

            // --- Views ---

            if (view === 'login') return (
                <div className="flex items-center justify-center min-h-screen">
                    <div className="bg-white p-10 rounded-2xl shadow-2xl w-96 border border-white/50 backdrop-blur-xl fade-in">
                        <div className="text-center mb-8">
                            <div className="bg-gradient-to-tr from-blue-500 to-indigo-600 p-4 rounded-full inline-flex mb-4 shadow-lg transform hover:scale-110 transition-transform">
                                <Icon name="User" className="w-8 h-8 text-white" />
                            </div>
                            <h2 className="text-3xl font-bold text-gray-800">Admin Login</h2>
                            <p className="text-gray-500 mt-2 text-sm">กรุณาเข้าสู่ระบบเพื่อจัดการข้อมูล</p>
                        </div>
                        <form onSubmit={handleLogin} className="space-y-6">
                            <div>
                                <label className="block text-sm font-medium text-gray-700 mb-2">รหัสผ่าน</label>
                                <div className="relative">
                                    <input 
                                        type="password" 
                                        value={loginPass} 
                                        onChange={e=>setLoginPass(e.target.value)} 
                                        className="w-full pl-10 pr-4 py-3 border border-gray-300 rounded-xl focus:ring-2 focus:ring-blue-500 focus:border-blue-500 transition-all outline-none" 
                                        placeholder="••••••••" 
                                        autoFocus 
                                    />
                                    <Icon name="Lock" className="w-5 h-5 text-gray-400 absolute left-3 top-3.5" />
                                </div>
                            </div>
                            <button type="submit" className="w-full bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white py-3 rounded-xl font-medium shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-0.5">
                                เข้าสู่ระบบ
                            </button>
                            <button type="button" onClick={()=>setView('dashboard')} className="w-full text-gray-500 text-sm hover:text-blue-600 hover:underline transition-colors">
                                กลับหน้าหลัก
                            </button>
                        </form>
                    </div>
                </div>
            );

            return (
                <div className="min-h-screen flex flex-col">
                    <LoadingOverlay />
                    <DetailModal />
                    <ReportModal />
                    <AdminReportModal />
                    
                    <nav className="bg-white/80 backdrop-blur-md shadow-md border-b border-indigo-100 sticky top-0 z-20 no-print">
                        <div className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                            <div className="flex justify-between h-16">
                                <div className="flex items-center cursor-pointer" onClick={()=>setView('dashboard')}>
                                    <img src="https://img5.pic.in.th/file/secure-sv1/760178309eefee095.png" alt="Logo" className="h-10 w-auto mr-3 drop-shadow-sm" />
                                    <span className="font-bold text-xl bg-clip-text text-transparent bg-gradient-to-r from-blue-600 to-indigo-600">e-Training | โรงเรียนครูเปิงมางfc</span>
                                    <div className="hidden sm:flex ml-8 space-x-2">
                                        <button onClick={()=>setView('dashboard')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${view==='dashboard'?'bg-blue-50 text-blue-700 shadow-sm':'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>Dashboard</button>
                                        <button onClick={()=>setView('list')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${view==='list'?'bg-blue-50 text-blue-700 shadow-sm':'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>รายการทั้งหมด</button>
                                        <button onClick={()=>setView('summary')} className={`px-4 py-2 rounded-lg text-sm font-medium transition-all duration-200 ${view==='summary'?'bg-blue-50 text-blue-700 shadow-sm':'text-gray-600 hover:bg-gray-50 hover:text-gray-900'}`}>สรุปรายบุคคล</button>
                                    </div>
                                </div>
                                <div className="flex items-center space-x-4">
                                    <button onClick={()=>{setFormData({images:[]}); setLocalFiles([null,null,null,null]); setView('form');}} className="bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white px-4 py-2 rounded-lg flex items-center shadow-md hover:shadow-lg transition-all text-sm font-medium transform hover:-translate-y-0.5">
                                        <Icon name="Plus" className="w-4 h-4 mr-1.5"/> บันทึกเพิ่ม
                                    </button>
                                    <div className="border-l border-gray-200 pl-4">
                                        {user==='admin' ? (
                                            <div className="flex items-center space-x-3">
                                                <span className="text-xs bg-indigo-100 text-indigo-800 px-3 py-1 rounded-full font-bold shadow-sm">Admin</span>
                                                <button onClick={handleLogout} className="text-gray-400 hover:text-red-500 transition-colors p-1 rounded-full hover:bg-red-50" title="ออกจากระบบ">
                                                    <Icon name="LogOut" className="w-5 h-5"/>
                                                </button>
                                            </div>
                                        ) : (
                                            <button onClick={()=>setView('login')} className="flex items-center text-gray-500 text-sm font-medium hover:text-blue-600 transition-colors px-2 py-1 rounded-lg hover:bg-blue-50">
                                                <Icon name="Lock" className="w-4 h-4 mr-1.5"/> Login
                                            </button>
                                        )}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </nav>

                    <main className="flex-1 max-w-7xl w-full mx-auto p-4 sm:p-8 no-print-padding">
                        {/* Summary View */}
                        {view === 'summary' && (
                            <div className="space-y-6 fade-in">
                                <div className="flex justify-between items-center bg-white p-6 rounded-xl shadow-lg border border-gray-100 no-print">
                                    <div>
                                        <h2 className="text-2xl font-bold text-gray-800">สรุปผลรายบุคคล</h2>
                                        <p className="text-gray-500 text-sm mt-1">ปีงบประมาณ {selectedYear}</p>
                                    </div>
                                    <select value={selectedYear} onChange={e=>setSelectedYear(e.target.value)} className="border-gray-200 bg-gray-50 rounded-lg text-sm px-4 py-2 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none">
                                        <option value="All">ทั้งหมด (ทุกปี)</option>
                                        {availableYears.map(y=><option key={y} value={y}>{y}</option>)}
                                    </select>
                                </div>
                                <div className="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-left text-sm">
                                            <thead className="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-wider">
                                                <tr>
                                                    <th className="p-4 w-16 text-center">ลำดับ</th>
                                                    <th className="p-4">ชื่อ-สกุล ผู้รายงาน</th>
                                                    <th className="p-4 text-center">จำนวนกิจกรรม</th>
                                                    <th className="p-4 text-center">ชั่วโมงรวม</th>
                                                    <th className="p-4 text-right">ดำเนินการ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {personStats.length > 0 ? personStats.map((p, idx) => (
                                                    <tr key={idx} className="hover:bg-blue-50/50 transition-colors">
                                                        <td className="p-4 text-center text-gray-500">{idx+1}</td>
                                                        <td className="p-4 font-medium text-gray-800 flex items-center">
                                                            <div className="w-8 h-8 rounded-full bg-gradient-to-br from-blue-100 to-indigo-100 flex items-center justify-center text-blue-600 mr-3 shadow-sm">
                                                                <Icon name="User" className="w-4 h-4"/>
                                                            </div>
                                                            {p.name}
                                                        </td>
                                                        <td className="p-4 text-center"><span className="bg-green-100 text-green-700 py-1 px-3 rounded-full font-bold text-xs">{p.count}</span></td>
                                                        <td className="p-4 text-center font-bold text-indigo-600">{p.hours}</td>
                                                        <td className="p-4 text-right">
                                                            <button onClick={() => setReportPerson(p.name)} className="text-blue-600 hover:text-blue-800 text-sm font-medium inline-flex items-center justify-end hover:bg-blue-50 px-3 py-1.5 rounded-lg transition-colors">
                                                                <Icon name="Printer" className="w-4 h-4 mr-1.5"/> พิมพ์รายงาน
                                                            </button>
                                                        </td>
                                                    </tr>
                                                )) : <tr><td colSpan="5" className="p-8 text-center text-gray-400">ไม่พบข้อมูล</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        )}

                        {/* Dashboard View */}
                        {view === 'dashboard' && (
                            <div className="space-y-8 fade-in">
                                <div className="flex flex-col md:flex-row justify-between items-center bg-white p-6 rounded-xl shadow-lg border-l-4 border-indigo-500 no-print">
                                    <div className="mb-4 md:mb-0">
                                        <h2 className="text-3xl font-bold text-gray-800">{user==='admin'?'Admin Dashboard':'ภาพรวมการพัฒนาตนเอง'}</h2>
                                        <p className="text-gray-500 mt-1">ข้อมูลประจำปีงบประมาณ <span className="font-bold text-indigo-600">{selectedYear === 'All' ? 'ทั้งหมด' : selectedYear}</span></p>
                                    </div>
                                    <div className="flex items-center space-x-3">
                                        {user === 'admin' && (
                                            <button onClick={() => setShowAdminReport(true)} className="flex items-center bg-white border border-gray-200 text-gray-700 hover:bg-gray-50 px-4 py-2 rounded-lg shadow-sm transition-all text-sm font-medium">
                                                <Icon name="Download" className="w-4 h-4 mr-2 text-indigo-600" /> รายงานภาพรวม
                                            </button>
                                        )}
                                        <select value={selectedYear} onChange={e=>setSelectedYear(e.target.value)} className="bg-indigo-50 border-indigo-100 text-indigo-700 font-medium rounded-lg text-sm px-4 py-2 focus:ring-2 focus:ring-indigo-500 outline-none cursor-pointer">
                                            <option value="All">ทุกปีงบประมาณ</option>
                                            {availableYears.map(y=><option key={y} value={y}>{y}</option>)}
                                        </select>
                                    </div>
                                </div>
                                
                                <div className="grid grid-cols-1 md:grid-cols-4 gap-6 no-print">
                                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow relative overflow-hidden group">
                                        <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name="Calendar" className="w-24 h-24 text-blue-600"/></div>
                                        <p className="text-gray-500 text-sm font-medium uppercase tracking-wider">ชั่วโมงรวม</p>
                                        <p className="text-4xl font-bold text-gray-800 mt-2">{stats.totalHours} <span className="text-lg font-normal text-gray-400">ชม.</span></p>
                                        <div className="w-full h-1 bg-gray-100 mt-4 rounded-full overflow-hidden"><div className="h-full bg-blue-500 w-3/4 rounded-full"></div></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow relative overflow-hidden group">
                                        <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name="FileText" className="w-24 h-24 text-green-600"/></div>
                                        <p className="text-gray-500 text-sm font-medium uppercase tracking-wider">กิจกรรมทั้งหมด</p>
                                        <p className="text-4xl font-bold text-gray-800 mt-2">{stats.totalCount} <span className="text-lg font-normal text-gray-400">ครั้ง</span></p>
                                        <div className="w-full h-1 bg-gray-100 mt-4 rounded-full overflow-hidden"><div className="h-full bg-green-500 w-1/2 rounded-full"></div></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow relative overflow-hidden group">
                                        <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name="CheckCircle" className="w-24 h-24 text-purple-600"/></div>
                                        <p className="text-gray-500 text-sm font-medium uppercase tracking-wider">อนุมัติแล้ว</p>
                                        <p className="text-4xl font-bold text-gray-800 mt-2">{stats.approvedCount} <span className="text-lg font-normal text-gray-400">รายการ</span></p>
                                        <div className="w-full h-1 bg-gray-100 mt-4 rounded-full overflow-hidden"><div className="h-full bg-purple-500 w-full rounded-full"></div></div>
                                    </div>
                                    <div className="bg-white p-6 rounded-xl shadow-md border border-gray-100 hover:shadow-lg transition-shadow relative overflow-hidden group">
                                        <div className="absolute right-0 top-0 p-4 opacity-10 group-hover:opacity-20 transition-opacity"><Icon name="Lock" className="w-24 h-24 text-yellow-500"/></div>
                                        <p className="text-gray-500 text-sm font-medium uppercase tracking-wider">รอตรวจสอบ</p>
                                        <p className="text-4xl font-bold text-gray-800 mt-2">{stats.pendingCount} <span className="text-lg font-normal text-gray-400">รายการ</span></p>
                                        <div className="w-full h-1 bg-gray-100 mt-4 rounded-full overflow-hidden"><div className="h-full bg-yellow-500 w-1/4 rounded-full"></div></div>
                                    </div>
                                </div>

                                {/* New Stats Row */}
                                <div className="grid grid-cols-1 md:grid-cols-2 gap-8 no-print">
                                    {/* Top 5 Reporters */}
                                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100">
                                        <h3 className="font-bold text-lg mb-6 text-gray-800 flex items-center">
                                            <div className="bg-yellow-100 p-2 rounded-lg mr-3"><Icon name="Trophy" className="w-5 h-5 text-yellow-600"/></div>
                                            5 อันดับผู้พัฒนาตนเองสูงสุด
                                        </h3>
                                        <div className="space-y-4">
                                            {stats.topReporters.length > 0 ? stats.topReporters.map((p, i) => (
                                                <div key={i} className="flex items-center justify-between p-3 rounded-lg hover:bg-gray-50 transition-colors border border-transparent hover:border-gray-100">
                                                    <div className="flex items-center">
                                                        <span className={`w-8 h-8 rounded-lg flex items-center justify-center text-sm mr-4 font-bold shadow-sm ${i===0?'bg-gradient-to-br from-yellow-100 to-yellow-200 text-yellow-700':i===1?'bg-gradient-to-br from-gray-100 to-gray-200 text-gray-700':i===2?'bg-gradient-to-br from-orange-100 to-orange-200 text-orange-700':'bg-blue-50 text-blue-600'}`}>
                                                            {i+1}
                                                        </span>
                                                        <span className="text-sm font-medium text-gray-700 truncate">{p.name}</span>
                                                    </div>
                                                    <span className="text-sm font-bold bg-indigo-50 text-indigo-700 px-3 py-1 rounded-full">{p.hours} ชม.</span>
                                                </div>
                                            )) : <p className="text-center text-gray-400 text-sm py-10">ยังไม่มีข้อมูล</p>}
                                        </div>
                                    </div>

                                    {/* Activity Type Chart */}
                                    <div className="bg-white p-6 rounded-xl shadow-lg border border-gray-100 h-96">
                                        <h3 className="font-bold text-lg mb-4 text-gray-800 flex items-center">
                                            <div className="bg-purple-100 p-2 rounded-lg mr-3"><Icon name="PieChart" className="w-5 h-5 text-purple-600"/></div>
                                            สัดส่วนประเภทกิจกรรม
                                        </h3>
                                        {isRechartsLoaded ? (
                                            <ResponsiveContainer width="100%" height="85%">
                                                <PieChart>
                                                    <Pie
                                                        data={stats.typeData}
                                                        cx="50%"
                                                        cy="50%"
                                                        innerRadius={70}
                                                        outerRadius={90}
                                                        fill="#8884d8"
                                                        paddingAngle={5}
                                                        dataKey="value"
                                                    >
                                                        {stats.typeData.map((entry, index) => (
                                                            <Cell key={`cell-${index}`} fill={COLORS[index % COLORS.length]} strokeWidth={0} />
                                                        ))}
                                                    </Pie>
                                                    <Tooltip contentStyle={{backgroundColor: '#fff', borderRadius: '8px', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'}} />
                                                    <Legend layout="vertical" verticalAlign="middle" align="right" />
                                                </PieChart>
                                            </ResponsiveContainer>
                                        ) : <div className="text-center text-gray-500 pt-20">Loading Chart...</div>}
                                    </div>
                                </div>
                                
                                {/* Latest List (Quick Management) */}
                                <div className="mt-8 no-print bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
                                    <div className="p-6 border-b border-gray-100 flex flex-col md:flex-row justify-between items-center gap-4 bg-gray-50/50">
                                        <h3 className="font-bold text-lg text-gray-800">รายการล่าสุด (จัดการด่วน)</h3>
                                        <div className="relative w-full md:w-auto">
                                            <Icon name="Search" className="w-4 h-4 absolute left-3 top-3 text-gray-400"/>
                                            <input 
                                                type="text" 
                                                placeholder="ค้นหาด่วน..." 
                                                className="pl-10 pr-4 py-2 border border-gray-200 rounded-lg text-sm w-full md:w-64 focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all"
                                                value={quickSearch}
                                                onChange={e => { setQuickSearch(e.target.value); setPage(1); }}
                                            />
                                        </div>
                                    </div>
                                    <div className="overflow-x-auto">
                                        <table className="w-full text-sm text-left">
                                            <thead className="bg-gray-50 text-gray-600 uppercase text-xs font-semibold tracking-wider">
                                                <tr>
                                                    <th className="p-4 font-semibold">วันที่</th>
                                                    <th className="p-4 font-semibold">หัวข้อ / ผู้รายงาน</th>
                                                    <th className="p-4 font-semibold text-center">ประเภท</th>
                                                    <th className="p-4 font-semibold text-center">สถานะ</th>
                                                    <th className="p-4 font-semibold text-right">จัดการ</th>
                                                </tr>
                                            </thead>
                                            <tbody className="divide-y divide-gray-100">
                                                {paginatedDashboardList.length > 0 ? paginatedDashboardList.map(item => (
                                                    <tr key={item.id} className="hover:bg-blue-50/30 transition-colors group">
                                                        <td className="p-4 whitespace-nowrap text-gray-500 font-medium">{item.dateStart}</td>
                                                        <td className="p-4">
                                                            <div className="font-bold text-gray-800 mb-1">{item.title}</div>
                                                            <div className="text-xs text-gray-500 flex items-center">
                                                                <Icon name="User" className="w-3 h-3 mr-1"/> {item.reporter} 
                                                                <span className="mx-2">•</span> 
                                                                {item.organizer}
                                                            </div>
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            <span className="bg-gray-100 text-gray-600 px-2 py-1 rounded text-xs border border-gray-200">{item.type}</span>
                                                        </td>
                                                        <td className="p-4 text-center">
                                                            {user === 'admin' ? (
                                                                <select 
                                                                    value={item.status} 
                                                                    onChange={(e)=>handleStatusChange(item.id, e.target.value)} 
                                                                    className={`text-xs px-2 py-1 rounded-full font-semibold border outline-none cursor-pointer transition-colors ${
                                                                        item.status==='approved' ? 'bg-green-50 text-green-700 border-green-200 hover:bg-green-100' : 
                                                                        item.status==='rejected' ? 'bg-red-50 text-red-700 border-red-200 hover:bg-red-100' : 
                                                                        'bg-yellow-50 text-yellow-700 border-yellow-200 hover:bg-yellow-100'
                                                                    }`}
                                                                >
                                                                    <option value="approved">อนุมัติ</option>
                                                                    <option value="pending">รอตรวจ</option>
                                                                    <option value="rejected">ไม่อนุมัติ</option>
                                                                </select>
                                                            ) : (
                                                                <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${
                                                                    item.status==='approved' ? 'bg-green-50 text-green-700 border-green-200' : 
                                                                    item.status==='rejected' ? 'bg-red-50 text-red-700 border-red-200' : 
                                                                    'bg-yellow-50 text-yellow-700 border-yellow-200'
                                                                }`}>
                                                                    {item.status==='approved'?'อนุมัติ':item.status==='rejected'?'แก้ไข':'รอตรวจ'}
                                                                </span>
                                                            )}
                                                        </td>
                                                        <td className="p-4 text-right">
                                                            <div className="flex justify-end space-x-2 opacity-80 group-hover:opacity-100 transition-opacity">
                                                                <button onClick={()=>setReportPerson(item.reporter)} className="p-1.5 rounded-lg text-gray-400 hover:text-indigo-600 hover:bg-indigo-50 transition-all" title="พิมพ์รายงานสรุปของบุคคลนี้"><Icon name="Printer" className="w-4 h-4"/></button>
                                                                <button onClick={()=>setDetailItem(item)} className="p-1.5 rounded-lg text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all" title="ดูรายละเอียด"><Icon name="Eye" className="w-4 h-4"/></button>
                                                                <button onClick={()=>{setFormData({...item, images: item.images || []}); setView('form');}} className="p-1.5 rounded-lg text-gray-400 hover:text-orange-500 hover:bg-orange-50 transition-all"><Icon name="Edit" className="w-4 h-4"/></button>
                                                                {user === 'admin' && <button onClick={()=>handleDelete(item.id)} className="p-1.5 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition-all"><Icon name="Trash2" className="w-4 h-4"/></button>}
                                                            </div>
                                                        </td>
                                                    </tr>
                                                )) : <tr><td colSpan="5" className="p-8 text-center text-gray-400">ไม่พบข้อมูลที่ค้นหา</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                    {/* Pagination Controls */}
                                    {totalPages > 1 && (
                                        <div className="flex justify-between items-center p-4 border-t border-gray-100 bg-gray-50/50">
                                            <button 
                                                onClick={() => setPage(p => Math.max(1, p - 1))}
                                                disabled={page === 1}
                                                className={`px-4 py-2 rounded-lg text-xs font-medium transition-all ${page === 1 ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 hover:text-blue-600 shadow-sm'}`}
                                            >
                                                ย้อนกลับ
                                            </button>
                                            <span className="text-xs font-medium text-gray-500">หน้า <span className="text-gray-900">{page}</span> จาก {totalPages}</span>
                                            <button 
                                                onClick={() => setPage(p => Math.min(totalPages, p + 1))}
                                                disabled={page === totalPages}
                                                className={`px-4 py-2 rounded-lg text-xs font-medium transition-all ${page === totalPages ? 'bg-gray-100 text-gray-400 cursor-not-allowed' : 'bg-white border border-gray-200 text-gray-600 hover:bg-gray-50 hover:text-blue-600 shadow-sm'}`}
                                            >
                                                ถัดไป
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        )}

                        {view === 'form' && (
                            <div className="bg-white p-8 rounded-xl shadow-lg max-w-4xl mx-auto border border-gray-100 fade-in">
                                <h2 className="text-2xl font-bold mb-8 flex items-center text-gray-800 border-b border-gray-100 pb-4">
                                    <div className="bg-blue-100 p-2 rounded-lg mr-3">
                                        <Icon name={formData.id ? 'Edit' : 'Plus'} className="w-6 h-6 text-blue-600" />
                                    </div>
                                    {formData.id ? 'แก้ไขข้อมูลการอบรม' : 'บันทึกการอบรมใหม่'}
                                </h2>
                                <form onSubmit={handleFormSubmit} className="space-y-6">
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {/* Row 1 */}
                                        <div className="col-span-2 md:col-span-1">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">ชื่อ-สกุล ผู้รายงาน <span className="text-red-500">*</span></label>
                                            <div className="relative">
                                                <input required type="text" className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 focus:border-transparent outline-none transition-all" placeholder="ระบุชื่อจริง นามสกุล" value={formData.reporter||''} onChange={e=>setFormData({...formData, reporter:e.target.value})} />
                                                <Icon name="User" className="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5" />
                                            </div>
                                        </div>
                                        <div className="col-span-2 md:col-span-1">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">เลขหนังสือ / คำสั่ง</label>
                                            <input type="text" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg bg-gray-50 focus:bg-white focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="เช่น ศธ 04..." value={formData.bookNumber||''} onChange={e=>setFormData({...formData, bookNumber:e.target.value})} />
                                        </div>

                                        {/* Row 2 */}
                                        <div className="col-span-2 md:col-span-1">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">ประเภทกิจกรรม</label>
                                            <div className="relative">
                                                <select className="w-full pl-4 pr-10 py-2.5 border border-gray-200 rounded-lg appearance-none bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer" value={formData.type||'อบรม'} onChange={e=>setFormData({...formData, type:e.target.value})}>{ACTIVITY_TYPES.map(t=><option key={t} value={t}>{t}</option>)}</select>
                                                <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div>
                                            </div>
                                        </div>
                                        <div className="col-span-2 md:col-span-1">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">หน่วยงานผู้จัด <span className="text-red-500">*</span></label>
                                            <input required type="text" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.organizer||''} onChange={e=>setFormData({...formData, organizer:e.target.value})} />
                                        </div>

                                        {/* Row 3 */}
                                        <div className="col-span-2">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">หัวข้อการอบรม <span className="text-red-500">*</span></label>
                                            <input required type="text" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all font-medium" value={formData.title||''} onChange={e=>setFormData({...formData, title:e.target.value})} />
                                        </div>

                                        {/* Row 4 */}
                                        <div>
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">รูปแบบการอบรม</label>
                                            <div className="relative">
                                                <select className="w-full pl-4 pr-10 py-2.5 border border-gray-200 rounded-lg appearance-none bg-white focus:ring-2 focus:ring-blue-500 outline-none cursor-pointer" value={formData.location||'ออนไลน์'} onChange={e=>setFormData({...formData, location:e.target.value})}><option value="ออนไลน์">ออนไลน์</option><option value="ออนไซต์">ออนไซต์</option></select>
                                                <div className="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none text-gray-500"><svg className="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth="2" d="M19 9l-7 7-7-7"></path></svg></div>
                                            </div>
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">จำนวนชั่วโมง <span className="text-red-500">*</span></label>
                                            <input required type="number" step="0.5" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" value={formData.hours||''} onChange={e=>setFormData({...formData, hours:e.target.value})} />
                                        </div>

                                        {/* Row 5 - New Location Detail */}
                                        <div className="col-span-2">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">ระบุสถานที่อบรม (ชื่อโรงแรม/ห้องประชุม/Link Zoom)</label>
                                            <div className="relative">
                                                <input type="text" className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all" placeholder="ระบุรายละเอียดสถานที่..." value={formData.locationDetail||''} onChange={e=>setFormData({...formData, locationDetail:e.target.value})} />
                                                <Icon name="Search" className="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5" />
                                            </div>
                                        </div>

                                        {/* Row 6 */}
                                        <div>
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">วันที่เริ่ม <span className="text-red-500">*</span></label>
                                            <input required type="date" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-gray-600" value={formData.dateStart||''} onChange={e=>setFormData({...formData, dateStart:e.target.value})} />
                                        </div>
                                        <div>
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">วันที่สิ้นสุด <span className="text-red-500">*</span></label>
                                            <input required type="date" className="w-full px-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-gray-600" value={formData.dateEnd||''} onChange={e=>setFormData({...formData, dateEnd:e.target.value})} />
                                        </div>
                                        
                                        <div className="col-span-2">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">สิ่งที่ได้รับจากการอบรม</label>
                                            <textarea className="w-full px-4 py-3 border border-gray-200 rounded-lg h-24 focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none" placeholder="สรุปเนื้อหาสำคัญ..." value={formData.knowledge||''} onChange={e=>setFormData({...formData, knowledge:e.target.value})}></textarea>
                                        </div>
                                        
                                        {/* New Field: Benefits */}
                                        <div className="col-span-2">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">ประโยชน์ที่ได้รับ (การนำไปใช้)</label>
                                            <textarea className="w-full px-4 py-3 border border-gray-200 rounded-lg h-24 focus:ring-2 focus:ring-blue-500 outline-none transition-all resize-none" placeholder="การนำความรู้ไปประยุกต์ใช้ในการเรียนการสอน..." value={formData.benefits||''} onChange={e=>setFormData({...formData, benefits:e.target.value})}></textarea>
                                        </div>

                                        {/* File Upload Section */}
                                        <div className="col-span-2 bg-slate-50 p-6 rounded-xl border border-dashed border-slate-300">
                                            <div className="flex justify-between items-center mb-4">
                                                <span className="font-bold text-sm text-slate-700 flex items-center"><Icon name="Image" className="w-4 h-4 mr-2"/> รูปภาพกิจกรรม (เลือกรูปจากเครื่อง)</span>
                                                <span className="text-xs bg-white px-2 py-1 rounded border text-slate-500">Max 4 images</span>
                                            </div>
                                            <div className="grid grid-cols-2 md:grid-cols-4 gap-4">
                                                {[0,1,2,3].map(i => {
                                                    const existingId = formData.images?.[i];
                                                    const localFile = localFiles[i];
                                                    return (
                                                        <div key={i} className="flex flex-col space-y-2 group">
                                                            {/* Show preview if available */}
                                                            <div className="relative w-full aspect-square bg-white rounded-lg border border-slate-200 overflow-hidden shadow-sm group-hover:border-blue-300 transition-colors">
                                                                {localFile ? (
                                                                    <>
                                                                        <img src={URL.createObjectURL(localFile)} className="w-full h-full object-cover" />
                                                                        <div className="absolute inset-0 bg-black/40 flex items-center justify-center text-white text-xs font-medium">รออัปโหลด</div>
                                                                    </>
                                                                ) : existingId ? (
                                                                    <>
                                                                        <img src={`https://lh3.googleusercontent.com/d/${existingId}`} className="w-full h-full object-cover" />
                                                                        <div className="absolute bottom-0 inset-x-0 bg-green-500/90 text-white text-[10px] text-center py-0.5">บันทึกแล้ว</div>
                                                                    </>
                                                                ) : (
                                                                    <div className="flex items-center justify-center h-full text-slate-300 group-hover:text-blue-300 transition-colors">
                                                                        <Icon name="Plus" className="w-8 h-8" />
                                                                    </div>
                                                                )}
                                                            </div>
                                                            <label className="cursor-pointer">
                                                                <span className="block w-full text-center text-xs bg-white border border-slate-300 text-slate-600 py-1.5 rounded hover:bg-slate-50 hover:text-blue-600 hover:border-blue-300 transition-all">เลือกรูป</span>
                                                                <input 
                                                                    type="file" 
                                                                    accept="image/*"
                                                                    className="hidden" 
                                                                    onChange={(e) => handleLocalFileChange(i, e.target.files[0])}
                                                                />
                                                            </label>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>

                                        <div className="col-span-2">
                                            <label className="block text-sm font-semibold mb-2 text-gray-700">ลิงก์เอกสารแนบเพิ่มเติม</label>
                                            <div className="relative">
                                                <input type="text" className="w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none transition-all text-blue-600" placeholder="https://..." value={formData.evidence||''} onChange={e=>setFormData({...formData, evidence:e.target.value})} />
                                                <Icon name="Upload" className="w-4 h-4 text-gray-400 absolute left-3.5 top-3.5" />
                                            </div>
                                        </div>
                                    </div>
                                    <div className="flex justify-end space-x-3 pt-6 border-t border-gray-100">
                                        <button type="button" onClick={()=>{setView('list'); setFormData({images:[]});}} className="px-6 py-2.5 border border-gray-300 rounded-lg text-gray-600 hover:bg-gray-50 font-medium transition-colors">ยกเลิก</button>
                                        <button type="submit" className="px-6 py-2.5 bg-gradient-to-r from-blue-600 to-indigo-600 hover:from-blue-700 hover:to-indigo-700 text-white rounded-lg shadow-md hover:shadow-lg flex items-center font-medium transition-all transform hover:-translate-y-0.5">
                                            <Icon name="Save" className="w-4 h-4 mr-2" /> บันทึกข้อมูล
                                        </button>
                                    </div>
                                </form>
                            </div>
                        )}

                        {view === 'list' && (
                            <div className="bg-white p-8 rounded-xl shadow-lg border border-gray-100 print:shadow-none print:p-0 print:border-none fade-in">
                                <div className="flex flex-col md:flex-row justify-between mb-6 gap-4 no-print">
                                    <div className="flex items-center gap-3">
                                        <div className="bg-indigo-100 p-2 rounded-lg"><Icon name="FileText" className="w-6 h-6 text-indigo-600"/></div>
                                        <h2 className="text-2xl font-bold text-gray-800">รายการทั้งหมด</h2>
                                    </div>
                                    <div className="flex space-x-3">
                                        <select value={selectedYear} onChange={e=>setSelectedYear(e.target.value)} className="border border-gray-200 bg-gray-50 rounded-lg text-sm px-4 py-2 focus:ring-2 focus:ring-blue-500 outline-none">
                                            <option value="All">ทั้งหมด (ทุกปี)</option>
                                            {availableYears.map(y=><option key={y} value={y}>{y}</option>)}
                                        </select>
                                        <div className="relative">
                                            <Icon name="Search" className="w-4 h-4 absolute left-3 top-3 text-gray-400"/>
                                            <input type="text" placeholder="ค้นหา..." className="pl-9 pr-4 py-2 border border-gray-200 rounded-lg text-sm w-48 focus:ring-2 focus:ring-blue-500 outline-none" value={searchTerm} onChange={e=>setSearchTerm(e.target.value)} />
                                        </div>
                                        <button onClick={() => window.print()} className="bg-gray-800 text-white px-4 py-2 rounded-lg flex items-center text-sm hover:bg-gray-900 shadow-sm transition-colors">
                                            <Icon name="Printer" className="w-4 h-4 mr-2" /> พิมพ์
                                        </button>
                                    </div>
                                </div>

                                {/* Print Header */}
                                <div className="hidden print:block text-center mb-8">
                                    <h1 className="text-2xl font-bold mb-2">รายงานสรุปการพัฒนาตนเอง (ข้าราชการครูและบุคลากรทางการศึกษา)</h1>
                                    <p className="text-base text-gray-600">
                                        ประจำปีงบประมาณ {selectedYear === 'All' ? 'ทั้งหมด' : selectedYear} 
                                        {searchTerm ? ` (คำค้นหา: "${searchTerm}")` : ''}
                                    </p>
                                </div>

                                <div className="overflow-x-auto print:overflow-visible">
                                    <table className="w-full text-left text-sm border-collapse">
                                        <thead className="bg-gray-50 text-gray-600 uppercase text-xs font-bold tracking-wider print:bg-gray-200 print:text-black">
                                            <tr>
                                                <th className="p-4 border-b border-gray-200 print:border-black">วันที่</th>
                                                <th className="p-4 border-b border-gray-200 print:border-black">หัวข้อ</th>
                                                <th className="p-4 border-b border-gray-200 text-center print:border-black">ประเภท</th>
                                                <th className="p-4 border-b border-gray-200 text-center print:border-black">ชม.</th>
                                                <th className="p-4 border-b border-gray-200 text-center print:border-black">สถานะ</th>
                                                <th className="p-4 border-b border-gray-200 text-right print:hidden">จัดการ</th>
                                            </tr>
                                        </thead>
                                        <tbody className="divide-y divide-gray-100 print:divide-black">
                                            {trainings.filter(t => (selectedYear==='All' || t.year.toString()===selectedYear.toString()) && (t.title.includes(searchTerm) || t.organizer.includes(searchTerm) || (t.reporter && t.reporter.includes(searchTerm)))).map(item => (
                                                <tr key={item.id} className="hover:bg-gray-50 print:border-b print:border-black">
                                                    <td className="p-4 whitespace-nowrap text-gray-500 print:text-black print:border-r print:border-black">{item.dateStart}</td>
                                                    <td className="p-4 print:border-r print:border-black">
                                                        <div className="font-bold text-gray-800 print:text-black mb-1">{item.title}</div>
                                                        <div className="text-xs text-gray-500 print:text-black">{item.reporter} | {item.organizer}</div>
                                                        {item.images && item.images.some(i=>i) && <div className="text-xs text-blue-500 flex items-center mt-1 no-print font-medium"><Icon name="Image" className="w-3 h-3 mr-1"/>มีรูปภาพ</div>}
                                                    </td>
                                                    <td className="p-4 text-center print:border-r print:border-black"><span className="bg-gray-100 px-2 py-1 rounded text-xs border border-gray-200 font-medium print:bg-transparent print:border-0">{item.type}</span></td>
                                                    <td className="p-4 text-center font-bold text-gray-700 print:text-black print:border-r print:border-black">{item.hours}</td>
                                                    <td className="p-4 text-center print:border-r print:border-black">
                                                        <div className="no-print">
                                                            {user === 'admin' ? (
                                                                <select value={item.status} onChange={(e)=>handleStatusChange(item.id, e.target.value)} className={`text-xs px-2 py-1 rounded-full font-semibold border outline-none cursor-pointer ${item.status==='approved'?'bg-green-50 text-green-700 border-green-200 hover:bg-green-100':'bg-yellow-50 text-yellow-700 border-yellow-200 hover:bg-yellow-100'}`}>
                                                                    <option value="approved">อนุมัติ</option><option value="pending">รอตรวจ</option><option value="rejected">ไม่อนุมัติ</option>
                                                                </select>
                                                            ) : <span className={`px-2 py-1 rounded-full text-xs font-semibold border ${item.status==='approved'?'bg-green-50 text-green-700 border-green-200':item.status==='rejected'?'bg-red-50 text-red-700 border-red-200':'bg-yellow-50 text-yellow-700 border-yellow-200'}`}>{item.status==='approved'?'อนุมัติ':item.status==='rejected'?'แก้ไข':'รอตรวจ'}</span>}
                                                        </div>
                                                        <span className="hidden print:inline text-xs font-bold">
                                                            {item.status==='approved'?'อนุมัติ':item.status==='rejected'?'ไม่อนุมัติ':'รอตรวจ'}
                                                        </span>
                                                    </td>
                                                    <td className="p-4 text-right space-x-2 print:hidden">
                                                        <button onClick={()=>setDetailItem(item)} className="p-1.5 rounded-lg text-gray-400 hover:text-blue-600 hover:bg-blue-50 transition-all"><Icon name="Eye" className="w-4 h-4"/></button>
                                                        <button onClick={()=>{setFormData({...item, images: item.images || []}); setLocalFiles([null,null,null,null]); setView('form');}} className="p-1.5 rounded-lg text-gray-400 hover:text-orange-600 hover:bg-orange-50 transition-all"><Icon name="Edit" className="w-4 h-4"/></button>
                                                        {user === 'admin' && <button onClick={()=>handleDelete(item.id)} className="p-1.5 rounded-lg text-gray-400 hover:text-red-600 hover:bg-red-50 transition-all"><Icon name="Trash2" className="w-4 h-4"/></button>}
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                                
                                {/* Print Signature Footer */}
                                <div className="hidden print:flex mt-16 justify-end px-10 text-sm">
                                    <div className="text-center w-1/3">
                                        <p className="mt-8 border-b border-dotted border-black h-8 mb-2"></p>
                                        <p className="font-bold">ผู้รับรองรายงาน</p>
                                        <p className="mt-1">ตำแหน่ง..........................................................</p>
                                    </div>
                                </div>
                            </div>
                        )}
                    </main>

                    {/* Footer */}
                    <footer className="bg-white/80 backdrop-blur border-t border-indigo-50 py-6 text-center text-sm text-gray-500 mt-auto no-print">
                        <p>Copyright © 2025 ระบบรายงานการอบรม | Developed by <span className="text-indigo-600 font-semibold">ครูเปิงมางfc</span></p>
                    </footer>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
